import re


def _normalize(values: set[str]) -> set[str]:
    return {v.upper() for v in values}

PREV_HDR = (
    r'(?:'
    r'___ Disposition:'
    r'|Discharge Disposition:'
    r'|Facility:'
    r'|___:\nHome'
    r'|___:\nHome with Service'
    r')'
)

TARGET_HDR = (
    r'(?:'
    r'Discharge Diagnosis:'      # Discharge Diagnosis:
    r'|___ Diagnosis:'           # ___ Diagnosis:
    r'|Discharge ___:'           # Discharge ___:
    r'|Current Diagnoses:'       # Current Diagnoses:
    r'|___ischarge Diagnosis:'   # ___ischarge Diagnosis:
    r'|___:'                       # <<< bare placeholder >>>
    r')'
)

NEXT_HDR = (
    r'(?:'
    r'Discharge Condition:'
    r'|___ Condition:'
    r'|CONDITION:'
    r')'
)

_HEADING_LINES = {
    '# PRIMARY DIAGNOSES',
    '# PRIMARY DIAGNOSIS',
    '# PRIMARY DIAGNOSIS:',
    '#PRIMARY',
    '#PRIMARY DIAGNOSES',
    '#PRIMARY DIAGNOSES:',
    '#PRIMARY DIAGNOSIS',
    '#PRIMARY DIAGNOSIS:',
    '#PRIMARY:',
    '(PRIMARY)',
    '* PRIMARY',
    '**PRIMARY',
    '**PRIMARY: ',
    '-PRIMARY DIAGNOSIS:',
    '-PRIMARY:',
    '.',
    '. PRIMARY:',
    '.PRIMARY:',
    "1' DIAGNOSIS ",
    "1' DIAGNOSIS:",
    '1* DIAGNOSIS:',
    '1. PRIMARY DIAGNOSIS',
    '1. PRIMARY:',
    '= = = = = = = = =',
    '=-------------------',
    '================-=',
    '======================-',
    '=================G',
    '===PRIMARY DIAGNOSES===',
    '===PRIMARY DIAGNOSIS===',
    'ACTIVE',
    'ACTIVE DIAGNOSES',
    'ACTIVE DIAGNOSES:',
    'ACTIVE HOSPITAL ISSUES:',
    'ACTIVE ISSUES',
    'ACTIVE ISSUES:',
    'ACTIVE ISSURE:',
    'ACTIVE PRIMARY:',
    'ACTIVE PROBLEM:',
    'ACTIVE PROBLEMS:',
    'ACTIVE/NEW:',
    'ACTIVE:',
    'ACTUE:',
    'ACUTE DIAGNOSES',
    'ACUTE DIAGNOSES:',
    'ACUTE DIAGNOSIS',
    'ACUTE DIAGNOSIS:',
    'ACUTE DX:',
    'ACUTE ISSUES:',
    'ACUTE MEDICAL DIAGNOSIS',
    'ACUTE PROBLEMS:',
    'ACUTE:',
    'ANGIOGRAPHIC FINDINGS:',
    'CURRENT THIS ADMISSION:',
    'CURRENT:',
    'DIAGNOSES',
    'DIAGNOSES ON THIS ADMISSION:',
    'DIAGNOSES:',
    'DIAGNOSIS',
    'DISCHARGE DIAGNOSES:',
    'DISCHARGE DIAGNOSIS',
    'DISCHARGE DIAGNOSIS:',
    'DISCHARGE WORKSHEET-DISCHARGE DIAGNOSIS-LAST UPDATED BY:',
    'DISCHARGED AMA WITHOUT PAPERWORK:',
    'DPRIMARY',
    'FINAL DIAGNOSES:',
    'FINAL DIAGNOSIS',
    'FINAL DIAGNOSIS:',
    'FIRST DIAGNOSIS:',
    'FOLLOW UP:',
    'HOME',
    'HOME WITH SERVICE',
    'INFORMATION WAS GIVEN TO HIM.***',
    'INJURIES:',
    'INPT:',
    'MAJOR:',
    'MEDICAL:',
    'NEW DIAGNOSES:',
    'NEW DIAGNOSIS:',
    'NEW:',
    'NOTE: PATIENT LEFT AMA BEFORE ANY OF THIS DISCHARGE PLANNING',
    'PARIMARY DIAGNOSES',
    'PARIMARY DIAGNOSIS',
    'PARIMARY DIAGNOSIS:',
    'PARIMARY:',
    'PAST MEDICAL HISTORY:\nHEMOLYTIC ANEMIA\nMR ___ MECHANICAL MVR IN ___\nCURRENT DIAGNOSES:',
    'PIMARY',
    'PIMARY DIAGNOSIS: ',
    'PIRMARY:',
    'PMH:',
    'POSITIVE BLOOD CULTURE:',
    'POSTOPERATIVE DIAGNOSES:',
    'PPRIMARY DIAGNOSIS',
    'PRAIMARY:',
    'PRELIMINARY DIAGNOSIS:',
    'PREOP DIAGNOSIS:',
    'PREOPERATIVE DIAGNOSES:',
    'PRIAMARY DIAGNOSES:',
    'PRIAMRY',
    'PRIAMRY DIAGNOSIS',
    'PRIAMRY DIAGNOSIS:',
    'PRIAMRY:',
    'PRIARY DIAGNOSES:',
    'PRIIMARY DIAGNOSIS',
    'PRIKMARY DIAGNOSIS:',
    'PRIMAARY:',
    'PRIMARTY DIAGNOSIS:',
    'PRIMARY',
    'PRIMARY -',
    'PRIMARY :',
    'PRIMARY DAIGNOSIS:',
    'PRIMARY DIABNOSIS:',
    'PRIMARY DIADNOSIS:',
    'PRIMARY DIAGANOSIS',
    'PRIMARY DIAGNODIS:',
    'PRIMARY DIAGNOES:',
    'PRIMARY DIAGNONSIS',
    'PRIMARY DIAGNOSE',
    'PRIMARY DIAGNOSES',
    'PRIMARY DIAGNOSES THIS ADMISSION',
    'PRIMARY DIAGNOSES THIS ADMISSION:',
    'PRIMARY DIAGNOSES-',
    'PRIMARY DIAGNOSES.',
    'PRIMARY DIAGNOSES:',
    'PRIMARY DIAGNOSI:',
    'PRIMARY DIAGNOSIES',
    'PRIMARY DIAGNOSIES:',
    'PRIMARY DIAGNOSIS',
    'PRIMARY DIAGNOSIS -',
    'PRIMARY DIAGNOSIS :',
    'PRIMARY DIAGNOSIS THIS ADMISSION',
    'PRIMARY DIAGNOSIS THIS ADMISSION:',
    'PRIMARY DIAGNOSIS.',
    'PRIMARY DIAGNOSIS/ES',
    'PRIMARY DIAGNOSIS/ES:',
    'PRIMARY DIAGNOSIS:',
    'PRIMARY DIAGNOSIS;',
    'PRIMARY DIAGNOSISIS:',
    'PRIMARY DIAGNOSOS:',
    'PRIMARY DIAGNOSOSES:',
    'PRIMARY DIAGNOSS:',
    'PRIMARY DIAGNSIS',
    'PRIMARY DIAGNSOIS:',
    'PRIMARY DIAGNSOSES',
    'PRIMARY DIAGNSOSES:',
    'PRIMARY DIAGNSOSI:',
    'PRIMARY DIAGNSOSIS',
    'PRIMARY DIAGNSOSIS:',
    'PRIMARY DIAGONIS',
    'PRIMARY DIAGONISS',
    'PRIMARY DIAGONOSES',
    'PRIMARY DIAGONOSES: ',
    'PRIMARY DIAGONOSIS',
    'PRIMARY DIAGONSES:',
    'PRIMARY DIAGONSIS',
    'PRIMARY DIAGONSIS THIS ADMISSION:',
    'PRIMARY DIAGONSIS:',
    'PRIMARY DIAGOSES:',
    'PRIMARY DIAGOSIS',
    'PRIMARY DIAGOSIS:',
    'PRIMARY DIAGSNOSIS',
    'PRIMARY DIANGNOSIS',
    'PRIMARY DIANGOSES',
    'PRIMARY DIANGOSES:',
    'PRIMARY DIANGOSIS',
    'PRIMARY DIANGOSIS:',
    'PRIMARY DIANOSES:',
    'PRIMARY DIANOSIS',
    'PRIMARY DIANOSIS:',
    'PRIMARY DIATGNOSIS:',
    'PRIMARY DIATNOSES',
    'PRIMARY DIGANOSES:',
    'PRIMARY DIGANOSIS',
    'PRIMARY DIGANOSIS:',
    'PRIMARY DIGNOSIS',
    'PRIMARY DIGNOSIS:',
    'PRIMARY DISAGNOSIS:',
    'PRIMARY DISCHARGE',
    'PRIMARY DISGNOAIS:',
    'PRIMARY DISGNOSES',
    'PRIMARY DISGNOSES:',
    'PRIMARY DISGNOSIS',
    'PRIMARY DISGNOSIS:',
    'PRIMARY DX',
    'PRIMARY DX:',
    'PRIMARY GIAGNOSES:',
    'PRIMARY ISSUE',
    'PRIMARY ISSUE:',
    'PRIMARY ISSUES',
    'PRIMARY ISSUES:',
    'PRIMARY MEDICAL DIAGNOSES',
    'PRIMARY PRIMARY DIAGNOSIS',
    'PRIMARY PROBLEMS',
    'PRIMARY PROBLEMS:',
    'PRIMARY.',
    'PRIMARY/ACTIVE DIAGNOSES ON DISCHARGE: ',
    'PRIMARY/ACTIVE DIAGNOSIS(ES)',
    'PRIMARY/ACTIVE DIAGNOSIS:',
    'PRIMARY:',
    'PRIMARY::',
    'PRIMARY;',
    'PRIMARYRY DIAGNOSES:',
    'PRIMAY',
    'PRIMAY DIAGNOSIS',
    'PRIMAY DIAGNOSIS:',
    'PRIMAY:',
    'PRIMRARY DIAGNOSES:',
    'PRIMRARY DIAGNOSIS:',
    'PRINCIPAL DIAGNOSES',
    'PRINCIPAL DIAGNOSES:',
    'PRINCIPAL DIAGNOSIS(ES)',
    'PRINCIPAL DIAGNOSIS:',
    'PRINCIPLE DIAGNOSIS:',
    'PRINCIPLE:',
    'PRMARY DIAGNOSES:',
    'PRMARY DIAGNOSIS',
    'PRMIARY DIAGNOSES',
    'PROIMARY DIAGNOSIS:',
    'RPIMARY DIAGNOSIS:',
    'STATUS POST MECHANICAL FALL:',
    'STATUS-POST ASSAULT:',
    'THIS ADMISSION:',
    '___:'
}

# ── prefixes to TRIM (discard prefix, keep remainder)
_TRIM_PREFIXES = {
    '#',
    '##',
    ')',
    '*',
    '-',
    '. PRIMARY:',
    "1' DIAGNOSIS",
    '1) PRIMARY:',
    '1)PRIMARY:',
    '1. PRIMARY DIAGNOSIS:',
    '1. PRIMARY:',
    ':',
    '==================',
    '?',
    'ADMISSION DIAGNOSIS:',
    'DIAGNOSIS:',
    'DISGNOSIS:',
    'DR. ___ DIAGNOSIS:',
    'DX:',
    'FINAL DIAGNOSES:',
    'FINAL DIAGNOSIS:',
    'FINAL:',
    'IMMEDIATE:',
    'MAIN DIAGNOSIS:',
    'MAJOR:',
    'MEDICAL:',
    'NEW DIAGNOSIS',
    'NEW DIAGNOSIS OF',
    'NEW DIAGNOSIS OF LIKELY',
    'NEWLY DIAGNOSED',
    'OSTOPERATIVE DIAGNOSIS:',
    'PIMARY DIAGNOSIS:',
    'PIMARY:',
    'POSTOP DIAGNOSES:',
    'POSTOP DIAGNOSIS:',
    'POSTOPERATIVE DIAGNOSES:',
    'POSTOPERATIVE DIAGNOSIS:',
    'PRE-OP DIAGNOSIS OF',
    'PRE-OP DIAGNOSIS:',
    'PRELIMINARY DIAGNOSIS:',
    'PREOP DIAGNOSIS:',
    'PREOP DX:',
    'PREOPERATIVE DIAGNOSES:',
    'PREOPERATIVE DIAGNOSIS OF',
    'PREOPERATIVE DIAGNOSIS:',
    'PREVIOUSLY DIAGNOSED',
    'PRIAMARY DIAGNOSES:',
    'PRIAMARY:',
    'PRIAMRY DIAGNOSIS:',
    'PRIAMRY:',
    'PRIMARY (DISCHARGE AGAINST MEDICAL ADVICE):',
    'PRIMARY -',
    'PRIMARY / ACUTE',
    'PRIMARY :',
    'PRIMARY DIAGNOIS:',
    'PRIMARY DIAGNOSES:',
    'PRIMARY DIAGNOSIS',
    'PRIMARY DIAGNOSIS:',
    'PRIMARY DIAGONOSES:',
    'PRIMARY DIAGONSIS:',
    'PRIMARY DIANGOSIS:',
    'PRIMARY DIGNOSIS:',
    'PRIMARY DX:',
    'PRIMARY DXS:',
    'PRIMARY-',
    'PRIMARY:',
    'PRIMARY;',
    'PRIMIARY:',
    'PRIMRAY:',
    'PRINCIPAL DIAGNOSIS:',
    'PRINCIPAL:',
    'PRINCIPLE DIAGNOSES:',
    'PRINCIPLE DIAGNOSIS:',
    'PRINCIPLE:',
    'PROVISIONAL DIAGNOSIS OF',
    'PROVISIONAL DIAGNOSIS:',
    'RECENTLY DIAGNOSED',
    "SURGEON'S PREOP DIAGNOSIS:",
    'THIS ADMISSION:',
    '[]',
    '___ DIAGNOSIS:',
    '___:'
}

# ── EARLY-END headers: stop output as soon as one appears
_END_SECTION_PREFIXES = {
    '. SECONDARY:',
    '.SECONDARY:',
    "2' DIAGNOSES",
    "2' DIAGNOSIS",
    '2) SECONDARY:',
    '2)SECONDARY:',
    '2* DIAGNOSES:',
    '2. SECONDARY DIAGNOSIS:',
    '2. SECONDARY:',
    '2.SECONDARY:',
    '===SECONDARY DIAGNOSES===',
    'ASSESSMENT & PLAN:',
    'ASSOCIATED DIAGNOSES:',
    'BRIEF HOSPITAL COURSE:',
    'CHIEF COMPLAINT:',
    'CHRONIC ISSUES/PMHX:',
    'CHRONIC ISSUES:',
    'CHRONIC ISSURES:',
    'CHRONIC PROBLEMS:',
    'CHRONIC/INACTIVE ISSUES:',
    'CHRONIC/STABLE ISSUES',
    'DEAR',
    'FOLLOW UP:',
    'FOLLOW-UP INSTRUCTIONS:',
    'GENERAL INSTRUCTIONS:',
    'IMPRESSION & RECOMMENDATIONS:',
    'IMPRESSION:',
    'INCIDENTAL FINDING:',
    'INTRA-OP:',
    'INVASIVE PROCEDURE ON THIS ADMISSION:',
    'MINOR:',
    'NO ACUTE DIAGNOSIS',
    'OTHER DIAGNOSES:',
    'OTHER DX:',
    'OTHER PMHX:',
    'OTHER:',
    'PAST CARDIAC PROCEDURES:',
    'PAST MEDICAL HISTORY:',
    'PAST SURGICAL HISTORY:',
    'PHYSICAL EXAMINATION:',
    'PMH:',
    'PMHX:',
    'PMX/PSX:',
    'POSTOPERATIVE DIAGNOSES:',
    'PREVIOUS SURGERIES/PROCEDURES:',
    'PROCEDURE:',
    'PROCEDURES:',
    'PSH:',
    'PSHX:SECONDARY/PMHX:',
    'RADIOLOGY RECOMMENDATION:',
    'REMOTE MEDICAL PROBLEMS:',
    'REOPERATIVE DIAGNOSES:',
    'SCEONDARY:',
    'SECODARY:',
    'SECONADARY DIAGNOSES',
    'SECONADRY DIAGNOSIS:',
    'SECONARY DX:',
    'SECONARY:',
    'SECONDAR DIAGNOSIS:',
    'SECONDARIY:',
    'SECONDARY -',
    'SECONDARY DAGINOSES:',
    'SECONDARY DAIGNOSES:',
    'SECONDARY DAIGNOSIS:',
    'SECONDARY DIAGNOS:',
    'SECONDARY DIAGNOSES',
    'SECONDARY DIAGNOSES:',
    'SECONDARY DIAGNOSIOS:',
    'SECONDARY DIAGNOSIOS:PHYSICAL EXAMINATION:',
    'SECONDARY DIAGNOSIOS:SECODARY:',
    'SECONDARY DIAGNOSIS',
    'SECONDARY DIAGNOSIS:',
    'SECONDARY DIAGNSOSES:',
    'SECONDARY DIAGONOSIS',
    'SECONDARY DIANOSES:',
    'SECONDARY DIANOSIS:',
    'SECONDARY DIATNOSES:',
    'SECONDARY DIGANOSIS',
    'SECONDARY DIGNOASES:',
    'SECONDARY DX:',
    'SECONDARY FINDING:',
    'SECONDARY ISSUES',
    'SECONDARY TREATMENT RELATED MDS',
    'SECONDARY-',
    'SECONDARY:',
    'SECONDARY;',
    'SECONDAY DIAGNOSES:',
    'SECONDAY DIAGNOSIS:',
    'SECONDAY:',
    'SEONCDARY :',
    'SEONCDARY DIAGNOSIS:',
    'SEONDARY DIAGNOSES:',
    'SEONDARY:',
    'SURG:',
    'VIRIDANS STREPTOCOCCI',
    'YOU HAVE BEEN DIAGNOSED WITH DIABETES',
    'YOU WERE ADMITTED',
    '___ 04:46AM'
}

_END_SECTION_FULL_LINES = {
    '* SECONDARY',
    '**SECONDARY',
    '**SECONDARY: ',
    "2' DIAGNOSES ",
    "2' DIAGNOSIS ",
    '2. SECONDARY DIAGNOSES',
    '==SECONDARY DIAGNOSES===',
    '>> SECONDARY DIAGNOSES:',
    'ADDITIONAL PMH:',
    'CHONIC:',
    'CHRONIC CONDITIONS:',
    'CHRONIC DIAGNO',
    'CHRONIC DIAGNOSES',
    'CHRONIC DIAGNOSES:',
    'CHRONIC DIAGNOSES: ',
    'CHRONIC DIAGNOSIS',
    'CHRONIC ISSUES/PMHX:',
    'CHRONIC ISSUES:',
    'CHRONIC ISUES:',
    'CHRONIC:',
    'FROM PRIMARY TEAM NOTE:',
    'HISTORY OF:',
    'MINOR:',
    'OTHER DIAGNOSES:',
    'OTHER DIAGNOSIS',
    'OTHER DIAGNOSIS/PAST MEDICAL HISTORY:',
    'OTHER DIAGNOSIS:',
    'OTHER PMHX',
    'OTHER PMHX:',
    'OTHERS:',
    'PAST CARDIAC PROCEDURES',
    'PAST CARDIAC PROCEDURES:',
    'PAST SURGICAL HISTORY',
    'PAST SURGICAL HISTORY:',
    'PHYSICAL EXAMINATION:',
    'PMH',
    'PMH-PRIMARY:',
    'PMH:',
    'PMHX:',
    'PREVIOUS ADMISSION:',
    'PSHX',
    'PSHX:',
    'SECODARY DIAGNOSES',
    'SECODARY DIAGNOSIS:',
    'SECODNARY DIAGNOSES',
    'SECOMDARY DIAGNOSES:',
    'SECONADARY DIAGNSOSIS',
    'SECONADRY DIAGNOSES:',
    'SECONADRY DIAGNOSIS:  ',
    'SECONARY',
    'SECONARY DIAGNOSES',
    'SECONARY DIAGNOSES:',
    'SECONARY DIAGNOSIS',
    'SECONARY DIAGNOSIS/ES:',
    'SECONARY:',
    'SECONDAR DIAGNOSES:',
    'SECONDARDY DIAGRNOSIS:',
    'SECONDARY',
    'SECONDARY  DIAGNOSIS',
    'SECONDARY ACTIVE DIAGNOSES:',
    'SECONDARY DAIGNOSIS',
    'SECONDARY DIAGNODES',
    'SECONDARY DIAGNOES:',
    'SECONDARY DIAGNOSIS',
    'SECONDARY DIAGNOSIS:',
    'SECONDARY DIAGNSOES:',
    'SECONDARY DIAGNSOSES',
    'SECONDARY DIAGNSOSIS:',
    'SECONDARY DIAGONSES:',
    'SECONDARY DIAGONSIS',
    'SECONDARY DIAGOSES:',
    'SECONDARY DIAGOSIS:',
    'SECONDARY DIAGSOSIS:',
    'SECONDARY DIANGNOSES:',
    'SECONDARY DIANGOSES:',
    'SECONDARY DIANGOSIS',
    'SECONDARY DIANGOSIS:',
    'SECONDARY DIANNOSES:',
    'SECONDARY DIANOSIS',
    'SECONDARY DIANOSIS:',
    'SECONDARY DIDAGNOSIS:',
    'SECONDARY DIGANOSES',
    'SECONDARY DIGNOSES:',
    'SECONDARY DIGNOSIS:',
    'SECONDARY DISGNOAIS:',
    'SECONDARY DISGNOSES',
    'SECONDARY DISGNOSES:',
    'SECONDARY DISGNOSIS',
    'SECONDARY DISGNOSIS:',
    'SECONDARY DX',
    'SECONDARY DXS:',
    'SECONDARY PROBLEMS',
    'SECONDARY PROBLEMS:',
    'SECONDARY/PMH:',
    'SECONDARY/PMHX:',
    'SECONDARY/STABLE:',
    'SECONDARY:',
    'SECONDARY;',
    'SECONDAY',
    'SECONDAY -',
    'SECONDAY DIAGNOSES',
    'SECONDAY DIAGNOSES THIS ADMISSION:',
    'SECONDAY DIAGNOSIS',
    'SECONDAY:',
    'SECONDRAY DIAGNOSIS:',
    'SECONDRAY:',
    'SECONDRY',
    'SECONODARY:',
    'SEDONDARY DIAGNOSES:',
    'SURGICAL HISTORY:',
    '___ DIAGNOSIS',
    '___ISCHARGE INSTRUCTIONS:'
}



EQUALS_ONLY_RE = re.compile(r'^\s*=+\s*$') # ===== (any length, spaces OK)
MINUS_ONLY_RE = re.compile(r'^\s*-+\s*$')  # any run of "-"

HEADING_LINES = _normalize(_HEADING_LINES)
_TRIM_PREFIXES = _normalize(_TRIM_PREFIXES)
END_SECTION_PREFIXES = _normalize(_END_SECTION_PREFIXES)
END_SECTION_FULL_LINES = _normalize(_END_SECTION_FULL_LINES)

TRIM_PREFIX_RE = re.compile(
    r'^(?:' + '|'.join(
        map(re.escape, sorted(_TRIM_PREFIXES, key=len, reverse=True))
    ) + r')',
    re.IGNORECASE,
    )
